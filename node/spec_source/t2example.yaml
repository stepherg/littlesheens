name: t2example
doc: none
parsepatterns: true
nodes:
  stop:
    branching:
      type: message
      branches:
        - pattern: |
            {"event":"start"}
          target: startup

  startup:
    actions:
      - interpreter: ecmascript
        source: |-
          var bs = _.bindings;
          var now = parseInt(Date.now()/1000)
          // register for RBUS events
          _.log("set up trigger conditions");
          _.out({"ts":now, "did":"task"});
          return _.bindings;
    branching:
      branches:
        - target: scheduleFirstInterval

  Task:
    actions:
      - interpreter: ecmascript
        source: |-
          var bs = _.bindings;
          var now = parseInt(Date.now()/1000)
          // get the RBUS stuff
          _.log("Running task");
          _.out({"ts":now, "did":"task"});
          return _.bindings;
      - type: RBUS
        method: GET
        paths: 
          - a
          - b
          - c
    branching:
      branches:
        # set first interval timer
        - target: Idle

  scheduleFirstInterval:
    branching:
      branches:
        - target: 
            dest: Idle
            # set timer event
            timer: 
              delay: 3000
              id: timer-firstInterval
        - target: Task

  schedulePeriodic:
    branching:
      branches:
        # set first interval timer
        - target: 
            dest: Idle
            # set timer event
            timer: 
              delay: 5000
              #delay: 86400
              id: timer-periodic
        - target: Task

  Idle:
    branching:
      type: message
      branches:
        - pattern: |
            {"event":"timer-firstInterval"}
          target: schedulePeriodic
        - pattern: |
            {"event":"timer-periodic"}
          target: schedulePeriodic
        - pattern: |
            {"event":"stop"}
          target: shutdown

  shutdown:
    action:
      interpreter: ecmascript
      source: |-
        var bs = _.bindings;
        var now = parseInt(Date.now()/1000)
        _.out({"ts":now, "did":"stopping"});
        return _.bindings;
    branching:
      branches:
        - target: stop

